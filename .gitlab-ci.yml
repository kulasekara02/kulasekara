
image: python:3.11

stages:
  - lint
  - test
  - build
  - deploy

variables:
  IMAGE: "\${CI_PROJECT_NAME}:\${CI_COMMIT_SHORT_SHA}"
  # Birthday 08 Feb 2001 -> month=2, day=8 -> 40000 + 208 = 40208
  PORT: "40208"

before_script:
  - python --version
  - pip install --upgrade pip
  - pip install -r app/requirements.txt
  - pip install flake8 pytest

lint_flake8:
  stage: lint
  script:
    - echo "Running flake8 linting..."
    - flake8 app

test_pytest:
  stage: test
  script:
    - echo "Running tests with pytest..."
    - pytest

build_app:
  stage: build
  script:
    - echo "Build step â€“ checking that the app compiles..."
    - python -m py_compile app/app.py

deploy_test:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "Starting Docker-in-Docker for TEST deploy..."
  rules:
    - if: '\$CI_COMMIT_REF_NAME =~ /^tst-.*$/'
  script:
    - echo "Deploying TEST version for Vihanga on port \${PORT}..."
    - docker build -t "tst-vihanga_kulasekara_\${CI_PROJECT_NAME}" .
    - docker stop "tst-vihanga_kulasekara_\${CI_PROJECT_NAME}" || true
    - docker rm "tst-vihanga_kulasekara_\${CI_PROJECT_NAME}" || true
    - docker run -d -p \${PORT}:5000 --name "tst-vihanga_kulasekara_\${CI_PROJECT_NAME}" "tst-vihanga_kulasekara_\${CI_PROJECT_NAME}"
    - echo "TEST app should be available at: http://<runner-host>:\${PORT}/"

deploy_prod:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "Starting Docker-in-Docker for PROD deploy..."
  rules:
    - if: '\$CI_COMMIT_REF_NAME == "main" || \$CI_COMMIT_REF_NAME == "master"'
  script:
    - echo "Deploying PRODUCTION version for Vihanga on port \${PORT}..."
    - docker build -t "prd-vihanga_kulasekara_\${CI_PROJECT_NAME}" .
    - docker stop "prd-vihanga_kulasekara_\${CI_PROJECT_NAME}" || true
    - docker rm "prd-vihanga_kulasekara_\${CI_PROJECT_NAME}" || true
    - docker run -d -p \${PORT}:5000 --name "prd-vihanga_kulasekara_\${CI_PROJECT_NAME}" "prd-vihanga_kulasekara_\${CI_PROJECT_NAME}"
    - echo "PROD app should be available at: http://<runner-host>:\${PORT}/"
EOF
