# GitLab CI/CD Lab - Vihanga Kulasekara
# Name: Vihanga Kulasekara
# Port: 40208  (Birthday: 8 Feb 2001)
# Branch: tst-assignment
# Container: tst-vihanga_kulasekara_tst-assignment

image: python:3.11

stages:
  - lint
  - test
  - build
  - deploy

variables:
  # App port based on birthday:
  PORT: "40208"
  # Fixed container name required by the lab
  CONTAINER_NAME: "tst-vihanga_kulasekara_tst-assignment"

# Common Python setup for lint/test/build
before_script:
  - python --version
  - python -m pip install --upgrade pip
  - pip install -r app/requirements.txt
  - pip install flake8 pytest

# 1) LINT
lint:
  stage: lint
  script:
    - echo "Running flake8..."
    - flake8 app

# 2) TEST
test:
  stage: test
  script:
    - echo "Running pytest..."
    - pytest

# 3) BUILD (just compile to check syntax)
build:
  stage: build
  script:
    - echo "Building (compiling) app..."
    - python -m py_compile app/app.py

# 4) DEPLOY (only on tst-assignment in GitLab)
deploy_test:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  # override global before_script (no Python here)
  before_script:
    - echo "Using Docker-in-Docker for deploy..."
  rules:
    - if: '$CI_COMMIT_REF_NAME == "tst-assignment"'
  script:
    - echo "Building Docker image: ${CONTAINER_NAME}"
    - docker build -t "${CONTAINER_NAME}" .
    - echo "Stopping old container (if exists)..."
    - docker stop "${CONTAINER_NAME}" || true
    - docker rm "${CONTAINER_NAME}" || true
    - echo "Running new container on port ${PORT} -> container port 5000"
    - docker run -d -p ${PORT}:5000 --name "${CONTAINER_NAME}" "${CONTAINER_NAME}"
    - echo "App should be available at: http://<runner-host>:${PORT}/"
